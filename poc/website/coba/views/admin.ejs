<!DOCTYPE html>
<html lang="id">
  <head>
    <title>Admin Dashboard - <%= currentClass %></title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet"/>

    <style>
      :root {
        --bg-color: #ffe6f2; 
        --card-bg: #ffffff;
        --primary-pink: #ff80ab;
        --dark-pink: #d81b60;
        --text-dark: #4a4a4a;
        --text-muted: #888888;
        --shadow-soft: 0 10px 30px rgba(255, 105, 180, 0.15);
      }

      body {
        background-color: var(--bg-color);
        font-family: "Poppins", sans-serif;
        color: var(--text-dark);
        overflow-x: hidden;
      }

      .sidebar {
        background: rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(10px);
        border-right: 1px solid rgba(255, 255, 255, 0.8);
        height: 100vh;
        position: fixed;
        width: 250px;
        padding: 30px 20px;
        z-index: 1000;
      }

      .brand-title { margin-bottom: 30px; display: flex; justify-content: center; align-items: center; }
      .logo-img { max-width: 100%; max-height: 75px; object-fit: contain; }

      .nav-pills .nav-link {
        color: var(--text-muted); font-weight: 500; border-radius: 15px; padding: 12px 20px; margin-bottom: 10px; transition: all 0.3s ease; display: flex; align-items: center; gap: 12px;
      }
      .nav-pills .nav-link:hover { background-color: rgba(255, 128, 171, 0.1); color: var(--dark-pink); }
      .nav-pills .nav-link.active { background: linear-gradient(135deg, #ff80ab, #f06292); color: white; box-shadow: 0 8px 20px rgba(240, 98, 146, 0.4); }

      .main-content { margin-left: 250px; padding: 40px; }
      .header-title { font-size: 2rem; font-weight: 700; color: var(--text-dark); margin-bottom: 5px; }
      .header-subtitle { color: var(--text-muted); margin-bottom: 30px; }

      .dashboard-card {
        background: var(--card-bg); border-radius: 25px; border: none; padding: 25px; box-shadow: var(--shadow-soft); height: 100%; transition: transform 0.3s ease;
      }
      
      .dashboard-card.h-auto { height: auto; }

      /* Tabel Gaya 1 (Untuk Manajemen Akun - Lama) */
      .custom-table { border-collapse: separate; border-spacing: 0 10px; }
      .custom-table tbody tr { background-color: #fff; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.02); border-radius: 10px; transition: transform 0.2s; }
      .custom-table tbody tr:hover { transform: translateY(-2px); }
      .custom-table td:first-child { border-top-left-radius: 15px; border-bottom-left-radius: 15px; }
      .custom-table td:last-child { border-top-right-radius: 15px; border-bottom-right-radius: 15px; }

      /* Tabel Gaya 2 (Untuk Live Scan - Baru) */
      .uid-table { border-collapse: separate; border-spacing: 0 10px; }
      .uid-table tbody tr { background-color: #fff; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.02); border-radius: 10px; }
      .uid-table td:first-child { border-top-left-radius: 15px; border-bottom-left-radius: 15px; }
      .uid-table td:last-child { border-top-right-radius: 15px; border-bottom-right-radius: 15px; }

      .btn-glass { background: rgba(255, 255, 255, 0.5); border: 1px solid rgba(255, 255, 255, 0.8); color: var(--dark-pink); border-radius: 50px; padding: 8px 20px; font-weight: 600; transition: 0.3s; }
      .btn-glass:hover { background: white; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }

      .class-badge { background-color: var(--dark-pink); color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.5em; vertical-align: middle; }
      .badge-custom { padding: 8px 12px; border-radius: 10px; font-weight: 600; font-size: 0.8rem; }
      .battery-indicator { font-size: 2rem; font-weight: 700; color: var(--dark-pink); display: flex; align-items: center; gap: 10px; }

      /* Animasi Pulse untuk Unknown Device */
      .pulse-red { animation: pulse-animation 2s infinite; }
      @keyframes pulse-animation {
        0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4); }
        70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
        100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
      }
      
      /* Scrollbar */
      ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: #fff0f5; } ::-webkit-scrollbar-thumb { background: #ffb6c1; border-radius: 10px; }
    </style>
  </head>
  <body>
    
    <div class="sidebar">
      <div class="brand-title">
        <img src="/images/logo.png" alt="Logo Aplikasi" class="logo-img">
      </div>
      
      <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist">
        <button class="nav-link active" id="v-pills-dashboard-tab" data-bs-toggle="pill" data-bs-target="#v-pills-dashboard">
          <i class="fas fa-satellite-dish"></i> Monitoring Live
        </button>
        <button class="nav-link" id="v-pills-accounts-tab" data-bs-toggle="pill" data-bs-target="#v-pills-accounts">
          <i class="fas fa-user-shield"></i> Manajemen Akun
        </button>
      </div>

      <div style="position: absolute; bottom: 30px; width: 85%;">
        <div class="card border-0 bg-white shadow-sm p-3 rounded-4">
            <div class="d-flex align-items-center gap-3">
                <img src="https://ui-avatars.com/api/?name=Admin&background=d81b60&color=fff" class="rounded-circle" width="40">
                <div>
                    <h6 class="mb-0 small fw-bold">Administrator</h6>
                    <small class="text-muted" style="font-size: 10px;">Super User</small>
                </div>
            </div>
            <a href="/" class="btn btn-sm btn-outline-danger w-100 mt-3 rounded-pill">Logout</a>
        </div>
      </div>
    </div>

    <div class="main-content">
      
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h1 class="header-title">
            Panel Admin 
            <span class="class-badge"><%= currentClass %></span>
          </h1>
          <p class="header-subtitle">Monitoring perangkat dan registrasi cepat.</p>
        </div>
        
        <div class="d-flex gap-2">
            <a href="/pilih-kelas?role=admin" class="btn btn-outline-secondary rounded-pill px-3 py-2 fw-bold">
                <i class="fas fa-exchange-alt me-2"></i> Ganti Kelas
            </a>
            
            <button class="btn btn-white bg-white text-dark border rounded-pill px-3 py-2 fw-bold shadow-sm" data-bs-toggle="modal" data-bs-target="#listModal">
                <i class="fas fa-list me-2"></i> List Mahasiswa
            </button>

            <button class="btn text-white rounded-pill px-4 py-2 shadow-sm fw-bold" style="background: var(--dark-pink);" onclick="openAddModal()">
                <i class="fas fa-plus me-2"></i> Tambah Baru
            </button>
        </div>
      </div>

      <div class="tab-content" id="v-pills-tabContent">
        
        <div class="tab-pane fade show active" id="v-pills-dashboard">
            <div class="row g-4">
                
                <div class="col-lg-5">
                    <div class="dashboard-card position-relative overflow-hidden">
                        <div style="position: absolute; top: -20px; right: -20px; width: 100px; height: 100px; background: #ff80ab; opacity: 0.1; border-radius: 50%;"></div>
                        
                        <div class="mb-4">
                            <label class="small text-muted fw-bold mb-2">PILIH PERANGKAT TERHUBUNG</label>
                            <form action="/admin" method="GET">
                                <input type="hidden" name="kelas" value="<%= currentClass %>">
                                <div class="input-group">
                                    <span class="input-group-text bg-light border-0"><i class="fas fa-microchip text-secondary"></i></span>
                                    <select name="device" class="form-select bg-light border-0 fw-bold text-dark" onchange="this.form.submit()">
                                        <% devices.forEach(dev => { %>
                                            <option value="<%= dev.id %>" <%= currentDevice.id === dev.id ? 'selected' : '' %>>
                                                <%= dev.name %> (<%= dev.status.toUpperCase() %>)
                                            </option>
                                        <% }) %>
                                    </select>
                                </div>
                            </form>
                        </div>

                        <div class="d-flex justify-content-between align-items-start mb-4 p-3 rounded-4" 
                             style="background-color: <%= currentDevice.status === 'online' ? '#e8f5e9' : '#ffebee' %>;">
                          <div>
                            <h5 class="fw-bold mb-1 text-dark"><%= currentDevice.name %></h5>
                            <div class="d-flex align-items-center gap-2">
                                <% if(currentDevice.status === 'online') { %>
                                    <span class="badge bg-success text-white badge-custom shadow-sm"><i class="fas fa-wifi me-1"></i> ONLINE</span>
                                <% } else { %>
                                    <span class="badge bg-danger text-white badge-custom shadow-sm"><i class="fas fa-wifi-slash me-1"></i> OFFLINE</span>
                                <% } %>
                                <small class="text-muted font-monospace"><%= currentDevice.id %></small>
                            </div>
                          </div>
                        </div>

                        <div class="d-flex align-items-end gap-3 mb-4">
                          <div class="battery-indicator" style="color: <%= currentDevice.status === 'online' ? (currentDevice.battery > 20 ? 'var(--dark-pink)' : '#dc3545') : '#999' %>;">
                            <i class="fas fa-battery-half"></i> 
                            <%= currentDevice.status === 'online' ? currentDevice.battery + '%' : '--' %>
                          </div>
                          <small class="text-muted mb-2">Status Daya Perangkat</small>
                        </div>

                        <form action="/api/simulate" method="POST" class="mt-auto">
                           <input type="hidden" name="current_class" value="<%= currentClass %>">
                           <input type="hidden" name="source" value="admin"> 
                           
                          <button class="btn btn-light w-100 py-2 text-secondary fw-bold rounded-pill border">
                            <i class="fas fa-magic me-2"></i> Simulasi Tap Kartu
                          </button>
                        </form>
                    </div>
                </div>

                <div class="col-lg-7">
                    <div class="dashboard-card">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div>
                                <h5 class="fw-bold mb-0">Aktivitas Scan (Live)</h5>
                                <small class="text-muted">Kartu yang terdeteksi perangkat saat ini.</small>
                            </div>
                            <span class="badge bg-light text-dark border"><%= currentList.length %> Scan</span>
                        </div>

                        <div style="max-height: 400px; overflow-y: auto;">
                            <table class="table uid-table align-middle border-0">
                                <tbody>
                                    <% if (currentList.length === 0) { %>
                                        <tr><td class="text-center text-muted py-5">Belum ada aktivitas scan.</td></tr>
                                    <% } %>
                                    
                                    <% currentList.forEach(item => { %>
                                    <tr class="<%= !item.isRegistered ? 'pulse-red' : '' %>">
                                        <td class="ps-4">
                                            <div class="d-flex align-items-center gap-3">
                                                <div class="bg-light rounded-circle p-2 text-secondary">
                                                    <i class="fas fa-id-card"></i>
                                                </div>
                                                <div>
                                                    <div class="fw-bold small text-secondary">RFID UID</div>
                                                    <div class="font-monospace text-dark fw-bold"><%= item.uid %></div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <% if(item.isRegistered) { %>
                                                <div class="fw-bold text-dark"><%= item.name %></div>
                                                <% if(item.isWrongClass) { %>
                                                    <span class="badge bg-warning text-dark">Kelas <%= item.kelas %></span>
                                                <% } else { %>
                                                    <small class="text-muted"><%= item.nim %></small>
                                                <% } %>
                                            <% } else { %>
                                                <span class="badge bg-danger rounded-pill px-3 py-2 mb-1">UNKNOWN</span>
                                                <div style="font-size: 10px;" class="text-danger">Belum Terdaftar</div>
                                            <% } %>
                                        </td>
                                        <td class="text-end pe-3">
                                            <% if(!item.isRegistered) { %>
                                                <button onclick="registerUnknown('<%= item.uid %>')" class="btn btn-sm btn-primary rounded-pill px-3 fw-bold" style="background: var(--dark-pink); border: none;">
                                                    <i class="fas fa-user-plus me-1"></i> Daftarkan
                                                </button>
                                            <% } else { %>
                                                <form action="/dosen/manage-uid" method="POST">
                                                    <input type="hidden" name="current_class" value="<%= currentClass %>">
                                                    <input type="hidden" name="action" value="delete">
                                                    <input type="hidden" name="uid" value="<%= item.uid %>">
                                                    <button class="btn btn-sm btn-light text-secondary rounded-circle" title="Hapus dari sesi">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </form>
                                            <% } %>
                                        </td>
                                    </tr>
                                    <% }) %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div class="tab-pane fade" id="v-pills-accounts">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="header-title">Manajemen Akun</h1>
                    <p class="header-subtitle">Atur hak akses login sistem.</p>
                </div>
            </div>

            <div class="row g-4">
                <div class="col-md-4">
                    <div class="dashboard-card h-auto">
                        <h5 class="fw-bold mb-4 text-dark">Buat Akun Baru</h5>
                        <form action="/admin/add-user" method="POST">
                             <input type="hidden" name="current_class" value="<%= currentClass %>">
                            <div class="mb-3">
                                <label class="small text-muted fw-bold mb-1">USERNAME</label>
                                <input type="text" name="username" class="form-control bg-light border-0 rounded-3 py-2" required>
                            </div>
                            <div class="mb-3">
                                <label class="small text-muted fw-bold mb-1">PASSWORD</label>
                                <input type="text" name="password" class="form-control bg-light border-0 rounded-3 py-2" required>
                            </div>
                            <div class="mb-4">
                                <label class="small text-muted fw-bold mb-1">ROLE</label>
                                <select name="role" class="form-select bg-light border-0 rounded-3 py-2">
                                    <option value="dosen">Dosen</option>
                                    <option value="admin">Admin</option>
                                </select>
                            </div>
                            <button type="submit" class="btn w-100 text-white fw-bold rounded-pill py-2" style="background: var(--dark-pink);">
                                <i class="fas fa-plus me-2"></i> Tambah User
                            </button>
                        </form>
                    </div>
                </div>

                <div class="col-md-8">
                    <div class="dashboard-card">
                        <h5 class="fw-bold mb-4">Akun Terdaftar</h5>
                        <div class="table-responsive">
                            <table class="table custom-table align-middle border-0">
                                <thead>
                                    <tr class="text-muted small text-uppercase">
                                        <th class="ps-4 border-0">User</th>
                                        <th class="border-0">Role</th>
                                        <th class="text-end pe-4 border-0">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% users.forEach(u => { %>
                                    <tr>
                                        <td class="ps-4">
                                            <div class="fw-bold text-dark"><%= u.username %></div>
                                            <small class="text-muted">Password: ****</small>
                                        </td>
                                        <td>
                                            <% if(u.role == 'admin') { %>
                                                <span class="badge bg-danger bg-opacity-10 text-danger rounded-pill px-3">ADMIN</span>
                                            <% } else { %>
                                                <span class="badge bg-info bg-opacity-10 text-info rounded-pill px-3">DOSEN</span>
                                            <% } %>
                                        </td>
                                        <td class="text-end pe-4">
                                            <form action="/admin/delete-user" method="POST" onsubmit="return confirm('Hapus user ini?');">
                                                <input type="hidden" name="current_class" value="<%= currentClass %>">
                                                <input type="hidden" name="id" value="<%= u.id %>">
                                                <button class="btn btn-sm btn-light text-danger rounded-circle"><i class="fas fa-trash"></i></button>
                                            </form>
                                        </td>
                                    </tr>
                                    <% }) %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

      </div>
    </div>

    <div class="modal fade" id="listModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 rounded-4 p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h5 class="modal-title fw-bold">Database Kelas <%= currentClass %></h5>
                        <p class="text-muted small mb-0">Total <%= students.length %> Mahasiswa</p>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Nama</th>
                                <th>NIM</th>
                                <th>RFID</th>
                                <th class="text-end">Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% students.forEach(s => { %>
                            <tr>
                                <td class="fw-bold"><%= s.name %></td>
                                <td><%= s.nim %></td>
                                <td class="font-monospace"><%= s.rfid %></td>
                                <td class="text-end">
                                    <div class="d-flex justify-content-end gap-2">
                                        <button class="btn btn-sm btn-outline-secondary" onclick="openEditModal('<%= s.id %>', '<%= s.name %>', '<%= s.nim %>', '<%= s.rfid %>')">
                                            <i class="fas fa-pen"></i>
                                        </button>
                                        <form action="/admin/delete" method="POST" onsubmit="return confirm('Hapus?');">
                                            <input type="hidden" name="current_class" value="<%= currentClass %>">
                                            <input type="hidden" name="id" value="<%= s.id %>">
                                            <button class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i></button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 rounded-4 p-4">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h5 class="modal-title fw-bold" id="addModalTitle">Tambah Mahasiswa</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <form action="/admin/add" method="POST">
            <input type="hidden" name="kelas" value="<%= currentClass %>">
            <input type="hidden" name="current_class" value="<%= currentClass %>">
            
            <div class="mb-3">
                <label class="small text-muted fw-bold">NAMA LENGKAP</label>
                <input type="text" name="name" class="form-control bg-light border-0 rounded-3" required placeholder="Contoh: Budi Santoso" />
            </div>
            <div class="mb-3">
                <label class="small text-muted fw-bold">NIM</label>
                <input type="text" name="nim" class="form-control bg-light border-0 rounded-3" required placeholder="Contoh: 13220001" />
            </div>
            <div class="mb-4">
                <label class="small text-muted fw-bold">RFID TAG (Scan/Input)</label>
                <div class="input-group">
                  <input type="text" name="rfid" id="rfidInputAdd" class="form-control bg-light border-0 rounded-start-3" placeholder="Menunggu tap..." required />
                  <button type="button" class="btn btn-dark" onclick="simulateScan('rfidInputAdd')"><i class="fas fa-wifi"></i></button>
                </div>
                <small class="text-muted" style="font-size: 11px;">*Tap kartu pada alat atau klik ikon wifi untuk simulasi.</small>
            </div>
            <button type="submit" class="btn w-100 text-white fw-bold rounded-pill py-2" style="background: var(--dark-pink);">Simpan ke Database</button>
          </form>
        </div>
      </div>
    </div>

    <div class="modal fade" id="editModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 rounded-4 p-4">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h5 class="modal-title fw-bold">Edit Mahasiswa</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <form action="/admin/edit" method="POST">
            <input type="hidden" name="current_class" value="<%= currentClass %>">
            <input type="hidden" name="id" id="editId" />
            <div class="mb-3">
                <label class="small text-muted fw-bold">NAMA LENGKAP</label>
                <input type="text" name="name" id="editName" class="form-control bg-light border-0 rounded-3" required />
            </div>
            <div class="mb-3">
                <label class="small text-muted fw-bold">NIM</label>
                <input type="text" name="nim" id="editNim" class="form-control bg-light border-0 rounded-3" required />
            </div>
            <div class="mb-4">
                <label class="small text-muted fw-bold">RFID TAG</label>
                <input type="text" name="rfid" id="editRfid" class="form-control bg-light border-0 rounded-3" required />
            </div>
            <button type="submit" class="btn w-100 text-white fw-bold rounded-pill py-2" style="background: var(--dark-pink);">Update Data</button>
          </form>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // 1. Open Add Modal Manual
      function openAddModal() {
          document.getElementById('rfidInputAdd').value = '';
          document.getElementById('addModalTitle').innerText = 'Tambah Mahasiswa Baru';
          new bootstrap.Modal(document.getElementById('addModal')).show();
      }

      // 2. Register Unknown (Auto-fill RFID)
      function registerUnknown(uid) {
          document.getElementById('rfidInputAdd').value = uid;
          document.getElementById('addModalTitle').innerText = 'Registrasi Kartu Baru';
          new bootstrap.Modal(document.getElementById('addModal')).show();
      }

      // 3. Open Edit Modal
      function openEditModal(id, name, nim, rfid) {
        // Tutup list modal jika terbuka
        const listModalEl = document.getElementById('listModal');
        const listModal = bootstrap.Modal.getInstance(listModalEl);
        if(listModal) listModal.hide();

        document.getElementById("editId").value = id;
        document.getElementById("editName").value = name;
        document.getElementById("editNim").value = nim;
        document.getElementById("editRfid").value = rfid;
        new bootstrap.Modal(document.getElementById("editModal")).show();
      }

      // 4. Simulate Scan Helper
      function simulateScan(inputId) {
        const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
        let result = "";
        for (let i = 0; i < 4; i++) result += chars.charAt(Math.floor(Math.random() * chars.length));
        result += "-";
        for (let i = 0; i < 4; i++) result += chars.charAt(Math.floor(Math.random() * chars.length));
        document.getElementById(inputId).value = result;
      }
    </script>
  </body>
</html>